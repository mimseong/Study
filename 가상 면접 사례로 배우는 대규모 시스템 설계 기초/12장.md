# 12장 채팅 시스템 설계

## 1단계 문제 이해 및 설계 범위 확정

- 응답지연이 낮은 일대일 채팅 기능
- 최개 100명까지 참여할 수 있는 그룹 채팅 기능
- 사용자의 접속상태 표시 기능
- 다양한 단말 지원, 하나의 계정으로 여러 단말에 동시 접속 지원

## 2단계 개략적 설계안 제시 및 동의 구하기

### 채팅 서버 설계

```
클리이언트 <-> 채팅 서버 <-> 클라이언트
```

- 클라이언트는 서로 직접 통신하지 않고 채팅 서버와 통신한다
- 채팅 서버가 제공해야 하는 기능
  - 클라이언트로부터 메시지 수신
  - 메시지 수신자 결정 및 전달
  - 수신자가 접속 상태가 아닌 경우 접속할 때까지 메시지 보관

<img width="1002" alt="image" src="https://github.com/mimseong/Study/assets/50068946/b1494b28-a009-41a0-a9d9-72bf644d5ef5">

**폴링**
- 클라이언트가 주기적으로 서버에게 새 메시지가 있냐고 물어보는 방식
- 단점: 답해줄 메시지가 없는 경우 서버 자원 낭비

**롱 폴링**

- 새 메시지가 반환되거나 타임아웃 될 때까지 연결 유지
- 클라이언트는 메시지를 받으면 기존 연결 종료 & 서버에 새로운 요청을 보낸다
- 단점: 메시지를 보내는 클라이언트와 메시지를 받는 클라이언트가 같은 채팅서버가 아닐 수 있다
- 단점: 여전히 비효율적임

**웹소켓**

- 웹 서버와 웹 브라우저가 서로 실시간 메시지를 교환하는데 사용 (양방향!)
- 첫 번째 핸드셰이크를 주고 받은 이후 지속적 연결 유지
- HTTP와 동일하게 애플리케이션 계층에서 동작
- 평문 메시지 전송 방식으로 SSL/TLS 보안 계층으로 암호화 필요
- 80, 443 포트를 쓰기 때문에 방화벽이 있어도 잘 통신함

### 전체 시스템 개략적 설계

서비스를 기준으로 설계

<img width="637" alt="image" src="https://github.com/mimseong/Study/assets/50068946/3b86c03c-1ad1-4655-8431-cb4884a6900c">

서버를 기준으로 설계

![image](https://github.com/mimseong/Study/assets/50068946/c6d5697d-651f-4be1-9b94-5721af01e7f1)

**데이터 모델 - 1:1 채팅**

- PK는 message id
- 메시지 순서를 쉽게 정할 수 있도록 해야 한다
- created_at을 PK로 할 수 없는 이유는 메시지가 동시에 만들어질 수도 있기 때문

**데이터 모델 - 그룹 채팅**

- PK는 (channel_id, message_id)
- channel_id는 파티션 키로 사용 가능
- message_to 말고 message_from이 있어야 할 것 같음

**메시지 id**

- 고유해야 한다
- 정렬 가능해야 하며 시간 순서와 일치해야 한다
- 새로운 ID는 이전 ID보다 큰 값이어야 한다
- 방법1: RDB의 auto_increment, NoSQL은 사용 불가
- 방법2: 스노우 플레이크 아이디 생성기
- 방법3: 지역적 순서 번호 생성기
  - id의 유일성은 같은 그룹 안에서만 보증하면 충분하다
  - 메시지 사이의 순서는 같은 채널 안에서만 유지되면 된다
  - 전역적 ID 생성기에 비해 구현하기 쉽다

## 3단계 상세 설계

개략적 설계안에 포함된 컴포넌트 가운데 몇 가지를 골라 자세히 들여다 보자

### 서비스 탐색

![image](https://github.com/mimseong/Study/assets/50068946/d0bb0ed7-c07e-4ca4-be55-39512f3184ed)


- 클라이언트에게 가장 적합한 채팅 서버 추천
- 기준: 클라이언트의 위치, 서버의 용량
- 아파치 주키퍼 같은 오픈소스 활용 가능
- 사용 가능한 모든 서버를 등록 후 클라이언트가 접속하면 최적의 채팅 서버 골라준다

### 메시지 전달 흐름

**1:1 채팅 메시지 처리 흐름**

1:1 채팅에서 사용자 A가 B로 보낸 메시지가 어떤 경로로 처리되는지

![image](https://github.com/mimseong/Study/assets/50068946/a18deec9-8be5-48d0-9086-8cf0448fdbb5)

**여러 단말 사이의 메시지 동기화**

여러 단말 사이에 메시지 동기화는 어떻게 하는지

### 사용자 접속 상태 표시








