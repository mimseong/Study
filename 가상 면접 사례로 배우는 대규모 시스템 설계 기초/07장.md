# 7장 분산 시스템을 위한 유일 ID 생성기 설계

- auto increment를 사용하는 건?
- 데이터베이스 서버 한 대로는 분산 환경 불가

## 문제 이해 및 설계 범위 확정

- ID는 유일해야 한다
- ID는 숫자로만 구성되어야 한다
- ID는 64비트로 표현 가능해야 한다
- ID는 발급 날짜에 따라 정렬 가능해야 한다
- 초당 10,000개의 ID를 만들 수 있어야 한다

## 개략적 설계안 제시 및 동의 구하기

- 다중 마스터 복제
- UUID
- 티켓 서버
- 트위터 스노플레이크

### 다중 마스터 복제

```
- MySQL1: 1, 3, 5, 7, ... 증가
- MySQL2: 2, 4, 6, 8, ... 증가
```

- auto_increment 기능 활용
- 데이터베이스 서버 개수 k만큼 증가
- ID 유일성 보장
- ID 숫자로만 구성, 64비트 표현 가능, 발급 날짜 정렬 가능
- 서버 개수 늘리기 어렵다 (k씩 늘리다가 k를 변경하기는 어렵다)

### UUID

- UUID: 정보를 유일하게 식별하기 위한 128비트 수
- 32자리 16진수로 표현된다
- RFC4122
- `8-4-4-4-12`
- 웹서버마다 별도의 uuid 생성 가능 -> 규모 확장이 쉽다
- 동기화 이슈가 없다
- ID가 128비트로 길다
- 시간순으로 정렬 불가능하다
- ID에 숫자가 아닌 값이 포함될 수 있다

### 티켓서버

- auto_increment 기능을 가진 티켓 서버 하나만 사용한다
- 구현하기 쉽다
- 티켓 서버가 SPOF (single point of failure)
- 티켓 서버 장애 발생시 모든 시스템 영향
- 티켓 서버 여러 대 둘 시 동기화 문제 발생

### 트위터 스노플레이크 접근법

```
64비트 ID 구조
- 1: 사인비트
- 41: 타임스템프
- 5: 데이터센터 ID
- 5: 서버 ID
- 12: 일련번호
```

- 사인비트: 음수, 양수 구분
- 타임스템프: epoch(기원시각) 이후로 몇 밀리초가 경과했는지
- 데이터센터 ID: 32개 데이터센터 활용 가능
- 서버 ID: 32개 서버 사용 가능
- 일련번호: 1밀리초동안 사용할 일련번호, 1밀리초 지나면 0으로 초기화

## 상세 설계

- 타임스템프, 일련번호: 시간이 갈수록 커진다, 시간순 정렬이 가능 (앞과 뒤에 둔 거 넘 기발하다)
- 데이터센터ID, 서버ID: 시스템이 시작할 때 결정
- 타임스템프로 저장할 수 있는 시간의 최댓값
  - 2^41 - 1 = 2199023255551
  - 2199023255551 / 1000(밀리초) / 60(초) / 60(분) / 24(시간) / 365(일) = 69(년)

## 마무리

추가로 더 생각해볼 것들

- 시계 동기화: 서버가 다른 시계를 사용한다면? NTP
- 각 단위 길이 최적화
- 고가용성: ID 생성기는 높은 가용성을 제공해야 한다







