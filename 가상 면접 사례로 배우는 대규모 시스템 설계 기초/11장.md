# 11장 뉴스 피드 시스템 설계 

뉴스 피드는 여러분의 홈 페이지 중앙에 지속적으로 업데이트되는 스토리들로, 사용자 상태 정보 업데이트, 사진, 비디오, 링크, 앱 활동 등등을 포함한다.

## 1단계 문제 이해 및 설계 범위 확정

- 뉴스 피드에 새로운 스토리를 올릴 수 있어야 한다 
- 친구들이 올리는 스토리를 볼 수 있어야 한다
- 뉴스 피드는 시간 흐름 역순으로 표시
- 한 명의 사용자는 최대 5000명의 친구를 가질 수 있다
- 트래픽 규모는 매일 천만 명

## 2단계 개략적 설계안 제시 및 동의 구하기

- 피드 발행: 사용자가 스토리를 포스팅하면 해당 데이터를 데이터베이스와 캐시에 기록, 새 포스팅은 친구의 뉴스피드에 전송
- 뉴스 피드 생성: 모든 친구의 포스팅을 시간 흐름 역순으로 모아서 만든다

### 뉴스 피드 API

- 피드 발행 API `POST /v1/me/feed`
  - 새 스토리를 포스팅하기 위한 API
  - body: 포스팅 내용
  - Authorization 헤더: API 호출을 인증하기 위해 사용된다
- 피드 읽기 API `GET /v1/me/feed`
  - 뉴스 피드 가져오는 API
  - Authorization 헤더: API 호출을 인증하기 위해 사용된다

### 피드 발행

- 사용자가 피드 발행을 했다
- 피드 발행 API `POST /v1/me/feed` 호출
- 로드밸런서를 통해 트래픽을 웹 서버로 분산
- 웹서버는 HTTP 요청을 내부 서비스로 중계 -> 포스팅 저장 서비스, 포스팅 전송 서비스, 알림 서비스
- 포스팅 저장 서비스: 새 포스팅을 데이터베이스와 캐시에 저장
- 포스팅 전송 서비스: 새 포스팅을 친구의 뉴스 피드로 푸시한다, 뉴스 피드 데이터는 캐시 보관
- 알림 서비스: 친구들에게 새 포스팅이 올라왔음을 알림

### 뉴스 피드 생성

- 사용자가 보는 뉴스피드
- 피드 읽기 API `GET /v1/me/feed` 호출
- 로드밸런서를 통해 트래픽을 웹 서버로 분산
- 웹서버는 트래픽을 뉴스 피드 서비스로 보낸다
- 뉴스 피드 서비스: 캐시에서 뉴스 피드를 가져오는 서비스
- 뉴스 피드 캐시: 뉴스 피드를 랜더링할 때 필요한 피드 ID를 보관

## 3단계 상세 설계

### 피드 발행 흐름 상세 설계

**웹 서버**

- 인증이나 처리율 제한 등의 기능 수행
- 올바른 인증 토큰으로 호출해야 포스팅 할 수 있다
- 특정 기간 동안 한 사용자가 올릴 수 있는 포스팅 수에 제한을 두어야 한다

**포스팅 전송 서비스**

- 포스팅 전송(팬아웃): 새 포스팅을 친구 사용자에게 전달하는 과정
- 쓰기 시점에 팬아웃 (푸시 모델)
  - 새로운 포스팅을 기록하는 시점에 뉴스 피드 갱신
  - 포스팅이 완료되면 해당 사용자 캐시에 포스팅 기록
  - 장점: 뉴스 피드가 실시간으로 갱신
  - 장점: 새 포스팅이 기록되는 순간 뉴스 피드가 갱신, 피드 읽는 시간이 짧다
  - 단점: 친구가 많은 사용자의 경우 친구 뉴스피드 모두 갱신하는데 많은 시간 소요
  - 단점: 서비스를 자주 사용하지 않는 사용자 피드까지 갱신, 컴퓨팅 자원 낭비
- 읽기 시점에 팬아웃 (풀 모델)
  - 피드를 읽어야 하는 시점에 뉴스 피드 갱신
  - 장점: 비활성화된 사용자, 서비스에 거의 로그인하지 않는 사용자의 경우 유리
  - 장점: 로그인하기까지 어떤 컴퓨팅 자원 소모 X
  - 장점: 데이터를 친구 각각에 푸쉬하는 작업이 필요 없다
  - 단점: 뉴스 피드를 읽는데 많은 시간이 소요될 수 있다
- 대부분의 사용자는 푸쉬 모델 사용
- 팔로워가 많은 사용자의 경우 팔로워로 하여금 포스팅 가져가도록 (풀 모델)
 
동작 방식
1. 그래프 데이터베이스에서 친구 ID 목록을 가져온다
2. 사용자 정보 캐시에서 친구들의 정보를 가져온다, 뮤트나 비공개를 제외한다
3. 친구 목록과 새 스토리 포스팅 ID를 메시지 큐에 넣는다
4. 팬아웃 작업 서버가 메시지 큐에 데이터를 꺼내서 뉴스 피드 캐시에 넣는다
   - 뉴스 피드 캐시 <포스팅 ID, 사용자 ID> 순서쌍 보관
   - 사용자 정보와 포스팅 정보를 전부 저장하지 않는 이유는 메모리 요구량이 지나치게 늘 수 있기 때문

### 피드 읽기 흐름 상세 설계



