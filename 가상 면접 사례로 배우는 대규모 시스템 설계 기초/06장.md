# 6장 키-값 저장소 설계

## 키-값 저장소

- 비관계형 데이터베이스
- 키는 유일해야 한다
- 키: 일반 텍스트 or 해시값
- 짧을수록 좋다
- 값: 문자열 / 리스트 / 객체 ...

## 단일 서버 키-값 저장소

- 모든 데이터를 메모리에 해시 테이블로 저장?
- 빠른 속도를 보장하지만 모든 데이터를 메모리 안에 두는 것이 불가능하다
- 개선책
  - 데이터 압축
  - 자주 쓰이는 데이터만 메모리에 두고 나머지는 디스크에 저장

## 분산 키-값 저장소

- 분산 해시 테이블이라고도 불린다
- 키-값 쌍을 여러 서버에 분산시킨다

### CAP 정리

```
- consistency: 데이터 일관성
  - 어떤 노드에 접속했는지 관계 없이 언제나 같은 데이터를 보게 되어야 한다
- availability: 가용성
  - 일부 노드에 장애가 발생하더라도 항상 응답을 받을 수 있어야 한다
- partition tolerance: 파티션 감내
  - 네트워크에 파티션이 생기더라도 시스템은 계속 동작해야 한다
```

- CAP 정리: 이들 가운데 어떤 두 가지를 충족하려면 나머지 하나는 반드시 희생해야 한다
- CP
  - 일관성을 챙기고 가용성을 희생한다 
  - 노드끼리 데이터가 일치해야 하므로 쓰기 연산 중단
- AP
  - 가용성을 챙기고 일관성을 희생한다
  - 낡은 데이터를 반환하더라도 읽기를 유지해야 한다
- CA
  - 네트워크 장애는 피할 수 없는 일이다.... CA 시스템은 존재하지 않는다

## 시스템 컴포넌트

### 데이터 파티션

- 전체 데이터를 한 대 서버에 욱여넣는 건 불가능하다
- 데이터를 작은 파티션으로 분할한 다음 여러 데이터 서버에 저장
- 데이터를 파티션으로 나눌 때 중요하게 따져봐야 하는 문제
  - 데이터를 여러 서버에 고르게 분산할 수 있는가
  - 노드가 추가되거나 삭제될 때 데이터의 이동을 최소화 할 수 있는가
- 안정 해시는 위 문제를 푸는데 적합한 기술
  - 규모 확장 자동화: 시스템 부하에 따라 서버가 자동으로 추가, 삭제
  - 다양성: 서버 용량에 따라 가상노드 수 조절 가능

### 데이터 다중화

- 높은 가용성과 안정성을 확보하기 위해서는 데이터를 N개 서버에 비동기적으로 다중화 할 필요가 있다
- 시계 방향으로 순회하면서 첫 N개의 서버에 사본 저장
- N개가 모두 같은 서버일수도 있다
- 물리 서버 중복 선택 조심

### 데이터 일관성

- 여러 노드에 다중화된 데이터는 적절히 동기화 되어야 한다
- 정족수 합의 프로토콜 사용
- N: 사본 개수
- W: 쓰기 연산에 대한 정족수
  - ex) W = 1
  - 쓰기 연
- R: 읽기 연산에 대한 정족수



