## ElasticSearch 소개

- Lucine 라이브러리 기반의 오픈소스 검색 엔진
- Lucine이 자바 라이브러리 기반이라 JDK 필요
- JSON 기반 문서를 저장, 검색, 분석 가능

### 특징

- 검색이 엄청 빠름
- 클러스터 구성이 가능해서 가용성이 높음
  - 한 대 이상의 노드로 클러스터를 구성하여 안정성이 높고 부하분산 가능
- 동적 스키마 생성
  - 입력될 데이터들에 대해 스키마를 정의하지 않아도 스키마 생성 가능
- Rest API 기반의 인터페이스
  - 클라이언트가 필요 없다

## 클러스터와 노드 이해하기

- 클러스터란: 여러 대의 컴퓨터들이 연결되어 하나의 시스템처럼 동작하는 컴퓨터들의 집합
- 클러스터의 성능이 부족하면 노드를 늘려서 대응 가능

### 노드의 종류

- 마스터 노드: 클러스터 상태 관리 및 메타데이터 관리
- 데이터 노드: 문서 색인 및 섬색 요청 처리
- 코디네이팅 노드: 검색 요청 처리
- 인제스트 노드: 색인되는 문서의 데이터 전처리

### 마스터 노드와 마스터 후보 노드

- 마스터 노드
- 마스터 후보 노드(Master-eligible): 마스터에 문제가 생겼을 시 마스터 될 수 있음

### 클러스터의 특징
- 어떤 노드에 어떤 요청을 해도 동일한 응답을 준다
- RDB는 Read/Write 역할이 나눠져있지만 es는 클러스터여서 응답이 같다 (오~)
- 위에서 마스터 노드는 클러스터 상태 & 메타데이터 관리를 한다고 했지만 마스터노드에게 데이터 요청을 해도 잘 처리해줌
- 내부적으로 마스터 노드가 데이터 노드로 요청해서 데이터 가져온다
- 위와 같은 경우는 불필요한 요청이 한 번 더 생긴다
- 각각의 노드가 역할에 맞게 구성되는 것이 중요하다

## 인덱스와 샤드 이해하기

- ES vs RDB
- index / database
- mapping / schema
- document / row

### 인덱스란?
- 문서가 저장되는 논리적인 공간
- 문서를 저장하기 위해서는 반드시 인덱스가 존재해야 함
- 인덱스 설계를 잘 해야 한다
- 로그 저장 용도로 쓰든.. 검색 용도로 쓰든..

### 인덱스 설계

**도서관 자료 검색 시스템을 만든다고 가정하면?**

- `library`라는 이름의 인덱스를 만들어서 모든 자료를 여기에 저장
- 각 자료 별로 인덱스를 따로 만들어서 저장 `book` `magazine`
- 인덱스 설계에 따라 문서 구조 및 검색 쿼리가 달라짐

**하나의 인덱스를 사용할 때**

- 장점: 관리해야 할 인덱스 수가 적어 관리 리소스가 적게 발생
- 단점: 쿼리와 문서의 구조가 복잡해질 수 있다
  - `book`과 `magazine`을 한번에 관리할 때 각각 필요한 필드가 다르다

**여러개의 인덱스로 나눌 때**
- 각각의 경우에 최적화된 쿼리와 문서 구조를 사용할 수 있다
- 관리해야 할 인덱스의 수가 많아 관리 리소스가 발생할 수 있다

하나의 인덱스로 단순하게 시작하고 사용 패턴에 따라 인덱스르 별도로 운영

### 샤드란?

- 인덱스는 문서가 저장되는 논리적인 공간
- 샤드는 인덱스에 색인되는 문서가 저장되는 공간
- 하나의 인덱스는 하나 이상의 샤드를 가진다

![image](https://github.com/mimseong/Study/assets/50068946/82de08ba-271d-4224-a9b6-aaca80c6fa15)

### 샤드의 종류

- 프라이머리 샤드:
  - 문서가 저장되는 원본 샤드
  - 색인과 검색 성능 영향
- 레플리카 샤드: 
  - 프라이머리 샤드의 복제 샤드
  - 검색 성능 영향
  - 프라이머리로 승격될 수 있음

### 샤드 설정

```
PUT /library/_settings
{
	index: {
		number_of_shards: 3
		number_of_replicas: 1
	}
}
```

- 프라이머리 샤드는 3개
- 프라이머리 각각 레플리카 1개
- 인덱스의 총 샤드는 6개

### 샤드 라우팅

- 3개의 샤드가 있다고 가정하면
- 문서는 0, 1, 2, 0, 1, 2 샤드에 순차적으로 저장된다
- 그래서 샤드를 늘릴 수 없음!
- 인덱스를 생성할 때 프라이머리 샤드의 개수를 설정하는 건 매우 중요
- number_of_shards의 기본값은 1 (조심!!)

### 샤드 설정 방법

```
PUT _index_template/base_template
{
	index_patterns: ["nginx-logs-*"],
	template: {
		settings: {
			numbers_of_shards: 3
			numbers_of_replicas: 2
		}
	}
}
```

- 인덱스 템플릿으로 샤드 개수를 설정할 수 있다
- `nginx-logs-`로 시작하는 모든 인덱스는 프라이머리 3개, 레플리카 6개로 생성

## 매핑 이해하기



